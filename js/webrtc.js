(function(){var d=(typeof window!=="undefined")?window.Gun:require("../gun");d.on("opt",function(k){this.to.next(k);var o=k.opt;if(k.once){return}if(!d.Mesh){return}if(false===o.RTCPeerConnection){return}var m;if(typeof window!=="undefined"){m=window}if(typeof global!=="undefined"){m=global}m=m||{};var p=o.RTCPeerConnection||m.RTCPeerConnection||m.webkitRTCPeerConnection||m.mozRTCPeerConnection;var a=o.RTCSessionDescription||m.RTCSessionDescription||m.webkitRTCSessionDescription||m.mozRTCSessionDescription;var l=o.RTCIceCandidate||m.RTCIceCandidate||m.webkitRTCIceCandidate||m.mozRTCIceCandidate;if(!p||!a||!l){return}o.RTCPeerConnection=p;o.RTCSessionDescription=a;o.RTCIceCandidate=l;o.rtc=o.rtc||{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.sipgate.net:3478"}]};o.rtc.dataChannel=o.rtc.dataChannel||{ordered:false,maxRetransmits:2};o.rtc.sdp=o.rtc.sdp||{mandatory:{OfferToReceiveAudio:false,OfferToReceiveVideo:false}};o.announce=function(e){k.on("out",{rtc:{id:o.pid,to:e}})};var n=o.mesh=o.mesh||d.Mesh(k);k.on("create",function(e){this.to.next(e);setTimeout(o.announce,1)});k.on("in",function(e){if(e.rtc){b(e)}this.to.next(e)});function b(f){var i=f.rtc,h,e;if(!i||!i.id){return}delete o.announce[i.id];if(e=i.answer){if(!(h=o.peers[i.id]||b[i.id])||h.remoteSet){return}return h.setRemoteDescription(h.remoteSet=new o.RTCSessionDescription(e))}if(e=i.candidate){h=o.peers[i.id]||b[i.id]||b({rtc:{id:i.id}});return h.addIceCandidate(new o.RTCIceCandidate(e))}if(b[i.id]){return}(h=new o.RTCPeerConnection(o.rtc)).id=i.id;var g=h.wire=h.createDataChannel("dc",o.rtc.dataChannel);b[i.id]=h;g.onclose=function(){delete b[i.id];n.bye(h)};g.onerror=function(j){};g.onopen=function(j){n.hi(h)};g.onmessage=function(j){if(!j){return}n.hear(j.data||j,h)};h.onicecandidate=function(j){if(!j.candidate){return}k.on("out",{"@":f["#"],rtc:{candidate:j.candidate,id:o.pid}})};h.ondatachannel=function(r){var j=r.channel;j.onmessage=g.onmessage;j.onopen=g.onopen;j.onclose=g.onclose};if(e=i.offer){h.setRemoteDescription(new o.RTCSessionDescription(e));h.createAnswer(function(j){h.setLocalDescription(j);k.on("out",{"@":f["#"],rtc:{answer:j,id:o.pid}})},function(){},o.rtc.sdp);return}h.createOffer(function(j){h.setLocalDescription(j);k.on("out",{"@":f["#"],rtc:{offer:j,id:o.pid}})},function(){},o.rtc.sdp);return h}});var c=function(){}}());