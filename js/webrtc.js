(function(){var a=(typeof window!=="undefined")?window.Gun:require("../gun");a.on("opt",function(d){this.to.next(d);var i=d.opt;if(d.once){return}if(!a.Mesh){return}if(false===i.RTCPeerConnection){return}var c;if(typeof window!=="undefined"){c=window}if(typeof global!=="undefined"){c=global}c=c||{};var f=i.RTCPeerConnection||c.RTCPeerConnection||c.webkitRTCPeerConnection||c.mozRTCPeerConnection;var h=i.RTCSessionDescription||c.RTCSessionDescription||c.webkitRTCSessionDescription||c.mozRTCSessionDescription;var e=i.RTCIceCandidate||c.RTCIceCandidate||c.webkitRTCIceCandidate||c.mozRTCIceCandidate;if(!f||!h||!e){return}i.RTCPeerConnection=f;i.RTCSessionDescription=h;i.RTCIceCandidate=e;i.rtc=i.rtc||{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.sipgate.net:3478"}]};i.rtc.dataChannel=i.rtc.dataChannel||{ordered:false,maxRetransmits:2};i.rtc.sdp=i.rtc.sdp||{mandatory:{OfferToReceiveAudio:false,OfferToReceiveVideo:false}};i.announce=function(k){d.on("out",{rtc:{id:i.pid,to:k}})};var j=i.mesh=i.mesh||a.Mesh(d);d.on("create",function(k){this.to.next(k);setTimeout(i.announce,1)});d.on("in",function(k){if(k.rtc){g(k)}this.to.next(k)});function g(m){var o=m.rtc,k,n;if(!o||!o.id){return}delete i.announce[o.id];if(n=o.answer){if(!(k=i.peers[o.id]||g[o.id])||k.remoteSet){return}return k.setRemoteDescription(k.remoteSet=new i.RTCSessionDescription(n))}if(n=o.candidate){k=i.peers[o.id]||g[o.id]||g({rtc:{id:o.id}});return k.addIceCandidate(new i.RTCIceCandidate(n))}if(g[o.id]){return}(k=new i.RTCPeerConnection(i.rtc)).id=o.id;var l=k.wire=k.createDataChannel("dc",i.rtc.dataChannel);g[o.id]=k;l.onclose=function(){delete g[o.id];j.bye(k)};l.onerror=function(p){};l.onopen=function(p){j.hi(k)};l.onmessage=function(p){if(!p){return}j.hear(p.data||p,k)};k.onicecandidate=function(p){if(!p.candidate){return}d.on("out",{"@":m["#"],rtc:{candidate:p.candidate,id:i.pid}})};k.ondatachannel=function(q){var p=q.channel;p.onmessage=l.onmessage;p.onopen=l.onopen;p.onclose=l.onclose};if(n=o.offer){k.setRemoteDescription(new i.RTCSessionDescription(n));k.createAnswer(function(p){k.setLocalDescription(p);d.on("out",{"@":m["#"],rtc:{answer:p,id:i.pid}})},function(){},i.rtc.sdp);return}k.createOffer(function(p){k.setLocalDescription(p);d.on("out",{"@":m["#"],rtc:{offer:p,id:i.pid}})},function(){},i.rtc.sdp);return k}});var b=function(){}}());